name: publish wiki
on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch:
jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          path: repo
      - name: checkout wiki
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.CICD_TOKEN }}
      - name: configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      - name: sync docs to wiki
        run: |
          find wiki -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} \;
          cp -r repo/docs/* wiki/
          cd wiki
          mv README.md Home.md
          # fix internal markdown links (remove .md extension)
          find . -name "*.md" -exec perl -pi -e 's/\]\((?!https?:\/\/)([^)]+)\.md([#][^)]+)?\)/](\1\2)/g' {} \;
          git add .
          if git diff --staged --quiet; then
            echo "nothing to commit"
            exit 0
          fi
          git commit -m "docs(wiki) sync"
          git push
