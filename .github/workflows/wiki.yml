name: publish wiki
on:
  # runs on changes to the docs folder in the main branch
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  # or manually
  workflow_dispatch:
jobs:
  sync-docs:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          path: repo
      - name: checkout wiki
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.CICD_TOKEN }}
      - name: configure git
        run: |
          # get the last commit author name and email
          cd repo
          COMMIT_NAME="${{ github.event.head_commit.author.name }}"
          COMMIT_EMAIL="${{ github.event.head_commit.author.email }}"
          # default to actor name if head_commit info is not available (e.g. onDispatch)
          if [ -z "$COMMIT_NAME" ]; then
            COMMIT_NAME="${{ github.actor }}"
            COMMIT_EMAIL="${{ github.actor }}@users.noreply.github.com"
          fi
          git config --global user.name "$COMMIT_NAME"
          git config --global user.email "$COMMIT_EMAIL"
          cd ..
      - name: sync docs to wiki
        run: |
          # clear wiki
          find wiki -mindepth 1 -maxdepth 1 -not -name '.git' -not -name 'img' -exec rm -rf {} \;
          # copy docs to wiki
          cp -r repo/docs/* wiki/
          cd wiki
          # rename index file
          mv README.md Home.md
          # update footer
          echo "## ▓▒▒░ &copy; 2018-$(date +"%Y") : [teXt0wnz](https://github.com/xero/text0wnz) ░▒▒▓" > _Footer.md
          # fix internal markdown linx (remove .md extension)
          find . -name "*.md" -exec perl -pi -e 's/\]\((?!https?:\/\/)([^)]+)\.md([#][^)]+)?\)/](\1\2)/g' {} \;
          git add .
          if git diff --staged --quiet; then
            echo "nothing to commit"
            exit 0
          fi
          git commit -m "docs(wiki) sync"
          git push
